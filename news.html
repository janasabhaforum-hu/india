<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Janasabha News</title>

  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />

  <style>
    /* ===== BASIC RESET ===== */
    * { margin: 0; padding: 0; box-sizing: border-box; }

    /* ===== THEME (News page theme) ===== */
    :root{
      --bg: #dbeafe;
      --card: #ffffff;
      --text: #0f172a;
      --muted:#64748b;
      --line:#e5e7eb;
      --soft:#f8fafc;
      --pill:#eef2ff;
      --shadow: 0 10px 22px rgba(2,6,23,.08);
      --radius: 18px;

      --accent:#6e9098;   /* search bar color */
      --accent2:#bfe3f3;  /* login button */
      --navH: 70px;       /* navbar height */
    }

    body{
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      margin:0;
    }
    a{ color:inherit; text-decoration:none; }

    /* ===== NAVBAR ===== */
    nav {
      background: #1b1b1b;
      height: var(--navH);
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 40px;
      position: fixed;
      top: 0;
      left: 0;
      z-index: 1000;
    }
    nav .logo { color: white; font-size: 30px; font-weight: 700; letter-spacing: 1px; }
    nav ul { display: flex; list-style: none; }
    nav ul li { margin: 0 15px; }
    nav ul li a { color: white; text-decoration: none; font-size: 16px; font-weight: 500; transition: 0.3s; }
    nav ul li a:hover, nav ul li a.active { color: yellow; }

    /* ===== MOBILE MENU ===== */
    .menu-toggle {
      display: none;
      font-size: 24px;
      color: white;
      background: none;
      border: none;
      cursor: pointer;
    }
    @media (max-width: 900px) {
      nav ul { display: none; }
      .menu-toggle { display: block; }
    }

    /* ===== LANGUAGE DROPDOWN MENU ===== */
    .language-dropdown { position: relative; display: inline-block; }
    .lang-btn {
      background: #1b1b1b;
      color: #fff;
      border: 1px solid #f1c40f;
      padding: 8px 15px;
      border-radius: 20px;
      font-size: 14px;
      cursor: pointer;
      transition: 0.3s;
    }
    .lang-btn:hover { background: #f1c40f; color: #1b1b1b; }

    .lang-menu {
      display: none;
      position: absolute;
      top: 100%;
      right: 0;
      background: white;
      min-width: 180px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
      border-radius: 8px;
      z-index: 1500;
      overflow: hidden;
    }
    .lang-menu a {
      color: #333;
      padding: 10px 15px;
      text-decoration: none;
      display: block;
      transition: background 0.3s;
      font-size: 14px;
    }
    .lang-menu a:hover { background: #f1c40f; color: #1b1b1b; }
    .lang-menu.show { display: block; }

    @media (max-width: 900px) {
      .language-dropdown {
        display: inline-block;
        position: absolute;
        right: 60px;
        top: 15px;
        z-index: 1200;
      }
      .lang-btn { padding: 6px 10px; font-size: 13px; }
    }

    /* ===== MOBILE OVERLAY ===== */
    .menu-overlay {
      position: fixed;
      inset: 0;
      display: none;
      align-items: stretch;
      justify-content: flex-start;
      z-index: 1200;
    }
    .menu-overlay.show { display: flex; }
    .menu-overlay::before {
      content: "";
      position: absolute;
      inset: 0;
      background: rgba(0, 0, 0, 0.45);
    }
    .side-menu {
      position: relative;
      width: 180px;
      height: 100%;
      background: rgb(101, 96, 96);
      transform: translateX(-100%);
      transition: transform 0.3s ease;
      padding: 30px 25px;
      z-index: 1300;
    }
    .menu-overlay.show .side-menu { transform: translateX(0); }
    .side-menu ul { list-style: none; }
    .side-menu ul li { margin: 15px 0; }
    .side-menu ul li a { color: white; text-decoration: none; font-size: 18px; }
    .close-btn {
      background: none;
      border: none;
      font-size: 30px;
      color: white;
      cursor: pointer;
      position: absolute;
      top: 15px;
      right: 20px;
    }

    /* ===== PAGE WRAP ===== */
    .wrap{max-width:1200px; margin:0 auto; padding:18px;}
    .pageContent{ padding-top: calc(var(--navH) + 22px); }

    /* Header */
    .headerCenter{ text-align:center; margin-bottom:10px; }
    .headerCenter h1{ margin:0; font-size:1.6rem; font-weight:900; }
    .headerCenter p{ margin:6px 0 0; color:var(--muted); font-size:.95rem; }

    /* ===== TOP BAR (Unified with Action Cards) ===== */
    .topBar{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap:14px;
      align-items:stretch;
      margin: 14px 0;
    }

    .actionCard{
      background: var(--card);
      border-radius: 999px;
      box-shadow: var(--shadow);
      border: 1px solid rgba(2,6,23,.06);
      padding: 10px 14px;
      display:flex;
      align-items:center;
      gap:10px;
      min-height: 52px;
    }

    .actionCard .label{
      font-weight:900;
      color:#0f172a;
      white-space:nowrap;
    }

    .actionCard select{
      width:100%;
      border:0;
      outline:none;
      background:transparent;
      font-weight:800;
      font-size:0.95rem;
      color:#0f172a;
      padding:6px 4px;
      appearance:auto;
    }

    @media (max-width: 768px){
      .topBar{ grid-template-columns: repeat(2, 1fr); }
    }

    /* Search */
    .searchBar{ width:100%; margin: 8px 0 14px; display:flex; justify-content:center; }
    .searchInput{
      width: 100%;
      max-width: 720px;
      padding:18px 22px;
      border-radius:999px;
      border:0;
      outline:none;
      background: var(--accent);
      color:#fff;
      box-shadow: var(--shadow);
      font-size:1.05rem;
    }
    .searchInput::placeholder{color: rgba(255,255,255,.85);}

    /* Layout */
    .layout{
      display:grid;
      grid-template-columns: 1.9fr .95fr;
      gap:16px;
      align-items:start;
    }

    /* Pager */
    .pager{
      display:flex;
      justify-content:center;
      align-items:center;
      gap:14px;
      margin: 10px 0 14px;
      flex-wrap:wrap;
    }
    .pager .pbtn{
      padding:10px 16px;
      border-radius:999px;
      border:0;
      background: var(--card);
      box-shadow: var(--shadow);
      font-weight:900;
      cursor:pointer;
    }
    .pager .pbtn:disabled{ opacity:.55; cursor:not-allowed; }
    .pager .pageChip{
      padding:10px 16px;
      border-radius:999px;
      background: var(--card);
      box-shadow: var(--shadow);
      font-weight:900;
      color: #334155;
    }

    /* Empty */
    .emptyCard{
      background: var(--card);
      border-radius: var(--radius);
      padding:18px;
      box-shadow: var(--shadow);
      color: var(--muted);
      border: 1px solid rgba(2,6,23,.06);
    }

    /* Featured + cards */
    .featured{
      background: var(--card);
      border-radius: var(--radius);
      overflow:hidden;
      box-shadow: var(--shadow);
      border: 1px solid rgba(2,6,23,.06);
      margin-bottom: 14px;
      cursor:pointer;
    }
    .featured .media{
      aspect-ratio: 16/7;
      background: var(--soft);
      display:flex;
      align-items:center;
      justify-content:center;
      color:var(--muted);
    }
    .featured img{width:100%; height:100%; object-fit:cover; display:block;}
    .featured .body{padding:14px 16px;}
    .featured h2{margin:0; font-size:1.2rem;}
    .metaLine{
      margin-top:8px;
      color: var(--muted);
      font-size:.9rem;
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
    }
    .badge{
      display:inline-flex;
      align-items:center;
      padding:6px 12px;
      border-radius:999px;
      background: var(--pill);
      font-weight:900;
      color:#334155;
    }
    .excerpt{margin:10px 0 0; color:var(--muted); line-height:1.5}

    .grid{
      display:grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap:14px;
    }
    .post{
      background: var(--card);
      border-radius: var(--radius);
      overflow:hidden;
      box-shadow: var(--shadow);
      border: 1px solid rgba(2,6,23,.06);
      cursor:pointer;
    }
    .post .thumb{
      aspect-ratio: 16/9;
      background: var(--soft);
      display:flex; align-items:center; justify-content:center;
      color: var(--muted);
    }
    .post .thumb img{width:100%; height:100%; object-fit:cover; display:block;}
    .post .body{padding:12px 14px;}
    .post h3{margin:0; font-size:1.02rem; line-height:1.35;}
    .post .small{margin:8px 0 0; color:var(--muted); font-size:.92rem; line-height:1.45;}

    /* Sidebar */
    .sideCard{
      background: var(--card);
      border-radius: var(--radius);
      padding:16px;
      box-shadow: var(--shadow);
      border: 1px solid rgba(2,6,23,.06);
      margin-bottom: 14px;
    }
    .sideCard h4{
      margin:0 0 12px;
      font-size:1.1rem;
      font-weight:900;
    }
    .sideInner{
      background: #f3f4f6;
      border: 1px dashed #d1d5db;
      border-radius: 14px;
      padding:14px;
      color: var(--muted);
    }

    /* Modal */
    .modal{
      position:fixed; inset:0;
      background: rgba(2,6,23,.45);
      display:none;
      align-items:center;
      justify-content:center;
      padding:16px;
      z-index:9999;
    }
    .modal.open{display:flex;}
    .modalCard{
      width:min(980px, 100%);
      max-height: 90vh;
      overflow:auto;
      background: var(--card);
      border-radius: 20px;
      box-shadow: 0 28px 80px rgba(2,6,23,.25);
      border:1px solid rgba(2,6,23,.08);
    }
    .modalTop{
      padding:12px 14px;
      border-bottom:1px solid rgba(2,6,23,.08);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      position:sticky;
      top:0;
      background: var(--card);
    }
    .closeBtn{
      padding:10px 14px;
      border-radius:999px;
      border:0;
      background: var(--soft);
      font-weight:900;
      cursor:pointer;
    }
    .modalBody{padding:14px;}
    .modalBody img{
      max-width:100%;
      border-radius:16px;
      border:1px solid rgba(2,6,23,.10);
      background:#fff;
    }
    .contentText{margin-top:10px; white-space:pre-wrap; line-height:1.65; color:#111827;}
    .shareRow{display:flex; gap:10px; flex-wrap:wrap; margin-top:12px;}
    .shareRow a, .shareRow button{
      border:0;
      border-radius:999px;
      padding:10px 14px;
      background: var(--soft);
      cursor:pointer;
      font-weight:900;
    }

    /* Responsive */
    @media (max-width: 980px){
      .layout{grid-template-columns:1fr;}
      .grid{grid-template-columns:1fr;}
    }
    @media (max-width: 620px){
      .topBar{grid-template-columns: 1fr; }
    }

    /* ===== FOOTER ===== */
    footer.footer {
      background: #2c3e50;
      color: white;
      padding: 60px 0 20px 0;
      margin-top: 24px;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial;
    }
    .container { max-width: 1100px; margin: 0 auto; padding: 0 16px; }
    .footer-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 40px;
      text-align: center;
    }
    .footer-section h3 { color: #f1c40f; margin-bottom: 15px; font-size: 1.2rem; }
    .footer-section ul { list-style: none; padding: 0; }
    .footer-section ul li { margin-bottom: 8px; }
    .footer-section ul li a { color: white; text-decoration: none; transition: 0.3s; }
    .footer-section ul li a:hover { color: #f1c40f; }

    .social-icons a {
      display: inline-block;
      width: 40px; height: 40px; line-height: 40px;
      margin: 5px;
      background: #f1c40f; color: #2c3e50;
      border-radius: 50%;
      text-align: center;
      font-size: 1.1rem;
      transition: 0.3s;
    }
    .social-icons a:hover { background: #d4ac0d; color: #fff; }
    .motto p { font-style: italic; font-size: 1rem; color: #f8f8f8; }

    .footer-bottom {
      margin-top: 40px;
      border-top: 1px solid rgba(255,255,255,0.2);
      text-align: center;
      padding-top: 15px;
      font-size: 0.9rem;
      color: #ddd;
    }
  </style>
</head>

<body>
  <!-- ===== NAVBAR ===== -->
  <nav>
    <div class="logo">Janasabha<span style="color: yellow;">‡§ú‡§® ‡§∏‡§≠‡§æ</span></div>

    <ul>
      <li><a href="index.html#home-section">Home</a></li>
      <li><a href="index.html#aboutus-section">About Us</a></li>
      <li><a href="page-mannjan.html">Model Unit</a></li>
      <li><a href="index.html#gallery-section">Gallery</a></li>
      <li><a href="index.html#testimony-section">Testimonies</a></li>
      <li><a href="index.html#Jointhemovement-section">Join the Movement</a></li>
      <li><a href="news.html" class="active">News</a></li>
      <li><a href="index.html#contact-section">Contact Us</a></li>
    </ul>

    <!-- Language Dropdown -->
    <div class="language-dropdown">
      <button class="lang-btn" id="langBtn" type="button">
        üåê <i class="fa fa-caret-down"></i>
      </button>
      <div class="lang-menu" id="langMenu">
        <a href="#" data-lang="en">English</a>
        <a href="#" data-lang="hi">‡§π‡§ø‡§®‡•ç‡§¶‡•Ä (Hindi)</a>
        <a href="#" data-lang="ml">‡¥Æ‡¥≤‡¥Ø‡¥æ‡¥≥‡¥Ç (Malayalam)</a>
        <a href="#" data-lang="ta">‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç (Tamil)</a>
        <a href="#" data-lang="te">‡∞§‡±Ü‡∞≤‡±Å‡∞ó‡±Å (Telugu)</a>
        <a href="#" data-lang="bn">‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ (Bengali)</a>
        <a href="#" data-lang="kn">‡≤ï‡≤®‡≥ç‡≤®‡≤° (Kannada)</a>
        <a href="#" data-lang="mr">‡§Æ‡§∞‡§æ‡§†‡•Ä (Marathi)</a>
      </div>
    </div>

    <button class="menu-toggle" id="openMenuBtn" aria-label="Open menu" type="button">
      <i class="fa fa-bars"></i>
    </button>
  </nav>

  <!-- ===== FLOATING MENU OVERLAY (MOBILE) ===== -->
  <div class="menu-overlay" id="menuOverlay">
    <div class="side-menu">
      <button class="close-btn" id="closeMenuBtn" type="button">&times;</button>
      <ul class="menu-list">
        <li><a href="index.html#home-section">Home</a></li>
        <li><a href="index.html#aboutus-section">About Us</a></li>
        <li><a href="page-mannjan.html">Model Unit</a></li>
        <li><a href="index.html#gallery-section">Gallery</a></li>
        <li><a href="index.html#testimony-section">Testimonies</a></li>
        <li><a href="index.html#Jointhemovement-section">Join the Movement</a></li>
        <li><a href="news.html" class="active">News</a></li>
        <li><a href="index.html#contact-section">Contact Us</a></li>
      </ul>
    </div>
  </div>

  <!-- ‚úÖ News Page Content -->
  <div class="wrap pageContent">
    <div class="headerCenter">
      <h1>Community News</h1>
      <p>Latest updates from our district and neighbourhood Janasabhas.</p>
    </div>

    <!-- Top button-cards row -->
    <div class="topBar">
      <div class="actionCard communityCard">
        <span class="label">Community/ies</span>
        <select id="communityFilter">
          <option value="ALL">All</option>
        </select>
      </div>

      <div class="actionCard">
        <span class="label">Latest Posts</span>
        <select id="latestSelect">
          <option value="">Select‚Ä¶</option>
        </select>
      </div>

      <div class="actionCard">
        <span class="label">Categories</span>
        <select id="categoryFilterTop">
          <option value="ALL">All</option>
        </select>
      </div>

      <div class="actionCard">
        <span class="label">Community Magazine</span>
        <select id="magCommunity">
          <option value="ALL">All</option>
        </select>
      </div>
    </div>

    <!-- Search -->
    <div class="searchBar">
      <input id="searchBox" class="searchInput" placeholder="Search news..." />
    </div>

    <div class="layout">
      <!-- LEFT MAIN -->
      <main>
        <div class="pager">
          <button class="pbtn" id="btnPrev" disabled>‚Üê Prev</button>
          <div class="pageChip" id="pageInfo">Page 1 / 1</div>
          <button class="pbtn" id="btnNext" disabled>Next ‚Üí</button>
        </div>

        <div id="emptyState" class="emptyCard" style="display:none;">No news found.</div>
        <div id="featuredWrap"></div>
        <div id="postsGrid" class="grid"></div>

        <!-- bottom pager (same buttons) -->
        <div class="pager">
          <button class="pbtn" id="btnPrev2" disabled>‚Üê Prev</button>
          <div class="pageChip" id="pageInfo2">Page 1 / 1</div>
          <button class="pbtn" id="btnNext2" disabled>Next ‚Üí</button>
        </div>
      </main>

      <!-- RIGHT SIDEBAR -->
      <aside>
        <div class="sideCard">
          <h4>Latest Posts</h4>
          <div id="latestWrap" class="sideInner">No posts yet.</div>
        </div>
      </aside>
    </div>
  </div>

  <!-- Modal -->
  <div class="modal" id="modal">
    <div class="modalCard">
      <div class="modalTop">
        <b id="modalTitle">News</b>
        <button class="closeBtn" id="btnClose">Close</button>
      </div>
      <div class="modalBody">
        <div class="metaLine" id="modalMeta"></div>
        <div id="modalMedia" style="margin-top:10px;"></div>
        <h2 id="modalH2" style="margin:12px 0 6px;"></h2>
        <div class="contentText" id="modalContent"></div>
        <div class="shareRow" id="shareRow"></div>
      </div>
    </div>
  </div>

  <!-- ===== FOOTER ===== -->
  <footer class="footer">
    <div class="container footer-grid">
      <div class="footer-section">
        <h3>Quick Links</h3>
        <ul>
          <li><a href="index.html#home-section">Home</a></li>
          <li><a href="index.html#aboutus-section">About Us</a></li>
          <li><a href="page-mannjan.html">Model Unit</a></li>
          <li><a href="index.html#gallery-section">Gallery</a></li>
          <li><a href="index.html#testimony-section">Testimonies</a></li>
          <li><a href="index.html#Jointhemovement-section">Join the Movement</a></li>
          <li><a href="index.html#contact-section">Contact Us</a></li>
          <li><a href="login.html">Admin Login</a></li>
        </ul>
      </div>

      <div class="footer-section">
        <h3>Connect With Us</h3>
        <div class="social-icons">
          <a href="#"><i class="fab fa-facebook-f"></i></a>
          <a href="#"><i class="fab fa-instagram"></i></a>
          <a href="#"><i class="fab fa-youtube"></i></a>
        </div>
      </div>

      <div class="footer-section motto">
        <h3>Our Motto</h3>
        <p>‚ÄúLove, Unity, and Development‚Äù</p>
      </div>
    </div>

    <div class="footer-bottom">
      <p>¬© 2025 Mannanam Janasabha. All Rights Reserved.</p>
    </div>
  </footer>

  <!-- ===== UI SCRIPTS (NAV + LANG) ===== -->
  <script>
    // Side menu
    document.addEventListener("DOMContentLoaded", function () {
      const openMenuBtn = document.getElementById("openMenuBtn");
      const closeMenuBtn = document.getElementById("closeMenuBtn");
      const menuOverlay = document.getElementById("menuOverlay");

      if (openMenuBtn && menuOverlay) {
        openMenuBtn.addEventListener("click", function () {
          menuOverlay.classList.add("show");
        });
      }

      if (closeMenuBtn && menuOverlay) {
        closeMenuBtn.addEventListener("click", function () {
          menuOverlay.classList.remove("show");
        });
      }

      if (menuOverlay) {
        menuOverlay.addEventListener("click", function (e) {
          if (e.target === menuOverlay) {
            menuOverlay.classList.remove("show");
          }
        });
      }
    });

    // Language dropdown toggle (click)
    const langBtn = document.getElementById("langBtn");
    const langMenu = document.getElementById("langMenu");

    if (langBtn && langMenu) {
      langBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        langMenu.classList.toggle("show");
      });

      document.addEventListener("click", (e) => {
        if (!e.target.closest(".language-dropdown")) {
          langMenu.classList.remove("show");
        }
      });
    }
  </script>

  <!-- Google Translate (optional) -->
  <script>
    function googleTranslateElementInit() {
      new google.translate.TranslateElement({
        pageLanguage: 'en',
        includedLanguages: 'en,hi,ml,ta,te,bn,kn,mr',
        layout: google.translate.TranslateElement.InlineLayout.SIMPLE
      }, 'google_translate_element');
    }
  </script>
  <script src="//translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script>

  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <script>
    // Firebase config (your project)
    const firebaseConfig = {
      apiKey: "AIzaSyCqxQKxSaNORdePg8xP6-ePmMr40DisFW0",
      authDomain: "janasabha-app.firebaseapp.com",
      projectId: "janasabha-app",
      storageBucket: "janasabha-app.firebasestorage.app",
      messagingSenderId: "596563440786",
      appId: "1:596563440786:web:4b8264e45afecc411aa24b"
    };

    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // DOM
    const communityFilter = document.getElementById("communityFilter");
    const magCommunity = document.getElementById("magCommunity");
    const searchBox = document.getElementById("searchBox");
    const categoryFilterTop = document.getElementById("categoryFilterTop");
    const latestSelect = document.getElementById("latestSelect");

    const featuredWrap = document.getElementById("featuredWrap");
    const postsGrid = document.getElementById("postsGrid");
    const emptyState = document.getElementById("emptyState");
    const latestWrap = document.getElementById("latestWrap");

    const btnPrev  = document.getElementById("btnPrev");
    const btnNext  = document.getElementById("btnNext");
    const pageInfo = document.getElementById("pageInfo");

    const btnPrev2  = document.getElementById("btnPrev2");
    const btnNext2  = document.getElementById("btnNext2");
    const pageInfo2 = document.getElementById("pageInfo2");

    // Modal
    const modal = document.getElementById("modal");
    const btnClose = document.getElementById("btnClose");
    const modalTitle = document.getElementById("modalTitle");
    const modalMeta  = document.getElementById("modalMeta");
    const modalMedia = document.getElementById("modalMedia");
    const modalH2    = document.getElementById("modalH2");
    const modalContent = document.getElementById("modalContent");
    const shareRow = document.getElementById("shareRow");

    if (btnClose && modal) {
      btnClose.onclick = () => modal.classList.remove("open");
      modal.addEventListener("click", (e) => { if(e.target === modal) modal.classList.remove("open"); });
    }

    // Magazine links (edit)
    const MAGAZINE_LINKS = {
      "ALL": "magazine.html",
      "Mannanam (Kottayam)": "magazine.html"
    };

    // State
    let allNews = [];
    let currentPage = 1;
    const SMALL_PER_PAGE = 7; // max small cards per page

    function safeText(v){ return (v ?? "").toString(); }

    function formatDate(ts){
      try{
        const d = ts?.toDate ? ts.toDate() : (ts ? new Date(ts) : null);
        if(!d || isNaN(d.getTime())) return "";
        return d.toLocaleDateString(undefined, { year:"numeric", month:"short", day:"numeric" });
      }catch(e){ return ""; }
    }

    function normalizeImageUrl(url){
      const u = safeText(url).trim();
      if(!u) return "";
      if(!/^https?:\/\//i.test(u)) return "";
      const driveMatch = u.match(/drive\.google\.com\/file\/d\/([^\/]+)\//i);
      if (driveMatch && driveMatch[1]) return `https://drive.google.com/uc?export=view&id=${driveMatch[1]}`;
      const openId = u.match(/drive\.google\.com\/open\?id=([^&]+)/i);
      if (openId && openId[1]) return `https://drive.google.com/uc?export=view&id=${openId[1]}`;
      return u;
    }

    function buildCommunityDropdown(){
      const set = new Set(allNews.map(n => safeText(n.community).trim()).filter(Boolean));
      const communities = ["ALL", ...Array.from(set).sort((a,b)=>a.localeCompare(b))];

      communityFilter.innerHTML = "";
      magCommunity.innerHTML = "";

      communities.forEach(c => {
        const label = c === "ALL" ? "All" : c;
        communityFilter.appendChild(new Option(label, c));
        magCommunity.appendChild(new Option(label, c));
      });

      if (!communities.includes(communityFilter.value)) communityFilter.value = "ALL";
      if (!communities.includes(magCommunity.value)) magCommunity.value = "ALL";
    }

    function buildCategoryDropdown(){
      const set = new Set(allNews.map(n => safeText(n.category).trim()).filter(Boolean));
      const cats = ["ALL", ...Array.from(set).sort((a,b)=>a.localeCompare(b))];

      const prev = categoryFilterTop.value || "ALL";
      categoryFilterTop.innerHTML = "";
      cats.forEach(c => categoryFilterTop.appendChild(new Option(c === "ALL" ? "All" : c, c)));
      categoryFilterTop.value = cats.includes(prev) ? prev : "ALL";
    }

    function buildLatestSelect(items){
      latestSelect.innerHTML = `<option value="">Select‚Ä¶</option>`;
      items.slice(0, 30).forEach(n => {
        const label = `${safeText(n.title) || "Untitled"} (${formatDate(n.date || n.createdAt)})`;
        latestSelect.appendChild(new Option(label, n.id));
      });
    }

    function getFiltered(){
      const comm = communityFilter.value || "ALL";
      const cat  = categoryFilterTop.value || "ALL";
      const q    = (searchBox.value || "").trim().toLowerCase();

      return allNews.filter(n => {
        const nComm = safeText(n.community).trim();
        const nCat  = safeText(n.category).trim();

        if (comm !== "ALL" && nComm !== comm) return false;
        if (cat  !== "ALL" && nCat !== cat) return false;

        if (!q) return true;
        const hay = (safeText(n.title)+" "+safeText(n.content)+" "+safeText(n.reporterName)).toLowerCase();
        return hay.includes(q);
      });
    }

    function updatePager(totalFiltered){
      const totalSmall = Math.max(0, totalFiltered - 1); // featured excluded
      const totalPages = Math.max(1, Math.ceil(totalSmall / SMALL_PER_PAGE));
      currentPage = Math.min(currentPage, totalPages);

      const txt = `Page ${currentPage} / ${totalPages}`;
      pageInfo.textContent = txt;
      pageInfo2.textContent = txt;

      const prevDisabled = currentPage <= 1;
      const nextDisabled = currentPage >= totalPages;

      btnPrev.disabled = prevDisabled;
      btnPrev2.disabled = prevDisabled;
      btnNext.disabled = nextDisabled;
      btnNext2.disabled = nextDisabled;
    }

    function renderFeatured(item){
      const img = normalizeImageUrl(item.mediaUrl);
      const dt = formatDate(item.date || item.createdAt);

      featuredWrap.innerHTML = `
        <div class="featured" id="featuredCard">
          <div class="media">
            ${img ? `<img src="${img}" alt="">` : `No image`}
          </div>
          <div class="body">
            <h2>${safeText(item.title) || "Untitled"}</h2>
            <div class="metaLine">
              <span class="badge">${safeText(item.community) || "All"}</span>
              <span class="badge">${safeText(item.category) || "General"}</span>
              <span>${dt}</span>
              <span>${item.reporterName ? "Reporter: " + safeText(item.reporterName) : ""}</span>
            </div>
            <div class="excerpt">${safeText(item.content).slice(0,160)}</div>
          </div>
        </div>
      `;
      document.getElementById("featuredCard").onclick = () => openPost(item);
    }

    function renderCards(items){
      postsGrid.innerHTML = "";
      items.forEach(item => {
        const img = normalizeImageUrl(item.mediaUrl);
        const dt = formatDate(item.date || item.createdAt);

        const el = document.createElement("div");
        el.className = "post";
        el.innerHTML = `
          <div class="thumb">${img ? `<img src="${img}" alt="">` : `No image`}</div>
          <div class="body">
            <h3>${safeText(item.title) || "Untitled"}</h3>
            <div class="small">${safeText(item.content).slice(0,100)}</div>
            <div class="metaLine" style="margin-top:10px;">
              <span class="badge">${safeText(item.community) || "All"}</span>
              <span class="badge">${safeText(item.category) || "General"}</span>
              <span>${dt}</span>
            </div>
          </div>
        `;
        el.onclick = () => openPost(item);
        postsGrid.appendChild(el);
      });
    }

    function renderLatest(items){
      const latest = items.slice(0, 6);
      if (!latest.length){ latestWrap.textContent = "No posts yet."; return; }

      latestWrap.innerHTML = "";
      latest.forEach((item, idx) => {
        const row = document.createElement("div");
        row.style.padding = "10px 0";
        row.style.borderBottom = (idx === latest.length - 1) ? "0" : "1px dashed #d1d5db";
        row.style.cursor = "pointer";
        row.innerHTML = `
          <div style="font-weight:900; color:#0f172a;">${safeText(item.title) || "Untitled"}</div>
          <div style="color:var(--muted); font-size:.88rem;">${formatDate(item.date || item.createdAt)}</div>
        `;
        row.onclick = () => openPost(item);
        latestWrap.appendChild(row);
      });
    }

    function buildShareButtons(item){
      const url = location.origin + location.pathname + `?id=${encodeURIComponent(item.id)}`;
      const text = `${safeText(item.title)} - Janasabha News`;
      shareRow.innerHTML = `
        <button id="copyLinkBtn">Copy Link</button>
        <a target="_blank" rel="noopener" href="https://wa.me/?text=${encodeURIComponent(text + " " + url)}">WhatsApp</a>
        <a target="_blank" rel="noopener" href="https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(url)}">Facebook</a>
      `;
      document.getElementById("copyLinkBtn").onclick = async () => {
        try{ await navigator.clipboard.writeText(url); alert("Link copied!"); }
        catch(e){ prompt("Copy this link:", url); }
      };
    }

    function openPost(item){
      modal.classList.add("open");
      modalTitle.textContent = safeText(item.title) || "News";

      const bits = [];
      if(item.community) bits.push(item.community);
      if(item.category) bits.push(item.category);
      const dt = formatDate(item.date || item.createdAt);
      if(dt) bits.push(dt);
      if(item.reporterName) bits.push("Reporter: " + item.reporterName);
      modalMeta.textContent = bits.join(" ‚Ä¢ ");

      const img = normalizeImageUrl(item.mediaUrl);
      modalMedia.innerHTML = img ? `<img src="${img}" alt="">` : "";
      modalH2.textContent = safeText(item.title) || "Untitled";
      modalContent.textContent = safeText(item.content) || "";
      buildShareButtons(item);
    }

    function render(){
      const filtered = getFiltered();

      emptyState.style.display = filtered.length ? "none" : "block";
      if(!filtered.length){
        featuredWrap.innerHTML = "";
        postsGrid.innerHTML = "";
        renderLatest([]);
        updatePager(0);
        return;
      }

      renderFeatured(filtered[0]);

      const rest = filtered.slice(1);
      const totalPages = Math.max(1, Math.ceil(rest.length / SMALL_PER_PAGE));
      currentPage = Math.min(currentPage, totalPages);

      const start = (currentPage - 1) * SMALL_PER_PAGE;
      const pageItems = rest.slice(start, start + SMALL_PER_PAGE);

      renderCards(pageItems);
      renderLatest(filtered);
      updatePager(filtered.length);
    }

    async function loadNews(){
      emptyState.style.display = "block";
      emptyState.innerHTML = "Loading news‚Ä¶";

      try{
        // Try date -> createdAt -> no order (fallback)
        let snap;
        try{
          snap = await db.collection("news").orderBy("date","desc").limit(200).get();
        }catch(e1){
          console.warn("orderBy(date) failed, trying createdAt:", e1?.message || e1);
          try{
            snap = await db.collection("news").orderBy("createdAt","desc").limit(200).get();
          }catch(e2){
            console.warn("orderBy(createdAt) failed, trying plain get:", e2?.message || e2);
            snap = await db.collection("news").limit(200).get();
          }
        }

        allNews = snap.docs.map(d => ({ id:d.id, ...d.data() }));

        buildCommunityDropdown();
        buildCategoryDropdown();
        buildLatestSelect(allNews);

        currentPage = 1;
        render();

        if (allNews.length) emptyState.style.display = "none";

        const params = new URLSearchParams(location.search);
        const id = params.get("id");
        if(id){
          const found = allNews.find(x => x.id === id);
          if(found) openPost(found);
        }
      }catch(err){
        console.error(err);
        emptyState.style.display = "block";
        emptyState.innerHTML = "‚ùå Failed to load news.<br><b>" + (err.message || err) + "</b>";
      }
    }

    // Events (safe)
    if (communityFilter) communityFilter.addEventListener("change", () => { currentPage = 1; render(); });
    if (categoryFilterTop) categoryFilterTop.addEventListener("change", () => { currentPage = 1; render(); });
    if (searchBox) searchBox.addEventListener("input", () => { currentPage = 1; render(); });

    if (latestSelect) {
      latestSelect.addEventListener("change", () => {
        const id = latestSelect.value;
        if(!id) return;
        const found = allNews.find(x => x.id === id);
        if(found) openPost(found);
        latestSelect.value = "";
      });
    }

    function goPrev(){ currentPage = Math.max(1, currentPage - 1); render(); }
    function goNext(){ currentPage = currentPage + 1; render(); }

    if (btnPrev)  btnPrev.onclick  = goPrev;
    if (btnPrev2) btnPrev2.onclick = goPrev;
    if (btnNext)  btnNext.onclick  = goNext;
    if (btnNext2) btnNext2.onclick = goNext;

    if (magCommunity) {
      magCommunity.addEventListener("change", () => {
        const c = magCommunity.value || "ALL";
        const link = MAGAZINE_LINKS[c] || MAGAZINE_LINKS["ALL"];
        window.location.href = link;
      });
    }

    // Start
    loadNews();
  </script>
<script>
 /* ===== Google Translate open in new tab ===== */
    document.querySelectorAll(".lang-menu a").forEach(item => {
      item.addEventListener("click", function (e) {
        e.preventDefault();
        const lang = this.dataset.lang;
        const currentURL = encodeURIComponent(window.location.href);
        const newURL = `https://translate.google.com/translate?hl=${lang}&sl=auto&u=${currentURL}`;
        window.open(newURL, "_blank");
      });
    });
  </script>
  
</body>
</html>
