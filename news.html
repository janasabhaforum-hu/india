<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Janasabha News</title>

  <style>
    :root{
      --bg:#d6e5f7;
      --text:#0f172a;
      --muted:#475569;
      --card:#ffffff;
      --line:#e2e8f0;
      --soft:#f8fafc;
      --accent:#0ea5e9;
      --radius:16px;
      --shadow: 0 10px 24px rgba(2,6,23,.08);
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background: var(--bg);
      color: var(--text);
    }
    a{color:inherit; text-decoration:none}

    .wrap{max-width:1180px; margin:0 auto; padding:16px;}

    /* Header */
    header{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
      margin-bottom:14px;
    }
    .brand h1{margin:0; font-size:1.35rem; letter-spacing:.2px;}
    .brand p{margin:.35rem 0 0; color:var(--muted);}

    .loginTop{
      display:flex;
      justify-content:flex-end;
      align-items:center;
      gap:10px;
      width:auto;
    }
    .btn{
      border:1px solid var(--line);
      background:var(--card);
      color:var(--text);
      padding:10px 14px;
      border-radius:999px;
      cursor:pointer;
      font-weight:700;
      box-shadow: 0 4px 10px rgba(2,6,23,.06);
    }
    .btn:hover{border-color:#cbd5e1}
    .btn.primary{
      border-color:rgba(14,165,233,.35);
      background: rgba(14,165,233,.10);
    }

    /* Toolbar (Community dropdown on left) */
    .toolbarRow{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      flex-wrap:wrap;
      margin: 10px 0 14px;
    }
    .toolbarLeft{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }
    .toolbar{
      display:flex;
      align-items:center;
      gap:8px;
      padding:10px 12px;
      border:1px solid var(--line);
      background:var(--card);
      border-radius:999px;
      box-shadow: 0 4px 10px rgba(2,6,23,.05);
    }
    .toolbar label{
      font-size:14px;
      color:var(--muted);
      white-space:nowrap;
    }
    select{
      border:1px solid var(--line);
      background:var(--soft);
      color:var(--text);
      padding:9px 12px;
      border-radius:999px;
      outline:none;
      min-width: 220px;
    }
    select:focus{
      border-color: rgba(14,165,233,.55);
      box-shadow: 0 0 0 3px rgba(14,165,233,.12);
    }

    /* Layout */
    .layout{
      display:grid;
      grid-template-columns: 1.9fr .9fr;
      gap:16px;
      align-items:start;
    }
    @media(max-width: 980px){
      .layout{grid-template-columns:1fr;}
      .loginTop{width:100%; justify-content:flex-start;}
    }

    /* Cards */
    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
    }

    /* Featured + grid */
    .featured{overflow:hidden; margin-bottom:14px;}
    .featured .media{
      aspect-ratio: 16/7;
      background: var(--soft);
      border-bottom:1px solid var(--line);
      display:flex; align-items:center; justify-content:center;
      color:var(--muted);
    }
    .featured img{width:100%; height:100%; object-fit:cover; display:block;}
    .featured .content{padding:14px;}
    .featured h2{margin:0; font-size:1.15rem; line-height:1.3;}
    .meta{
      display:flex; gap:10px; flex-wrap:wrap;
      color:var(--muted);
      font-size:.88rem;
      margin-top:6px;
    }
    .badge{
      display:inline-flex;
      align-items:center;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background: var(--soft);
      color: var(--muted);
      font-size:.85rem;
      font-weight:700;
    }
    .excerpt{margin:.55rem 0 0; color:var(--muted); line-height:1.45}

    .grid{
      display:grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap:14px;
    }
    @media(max-width: 720px){
      .grid{grid-template-columns:1fr;}
    }
    .post{overflow:hidden; display:flex; flex-direction:column;}
    .post .thumb{
      aspect-ratio:16/9;
      background:var(--soft);
      border-bottom:1px solid var(--line);
      display:flex; align-items:center; justify-content:center;
      color:var(--muted);
    }
    .post .thumb img{width:100%; height:100%; object-fit:cover; display:block;}
    .post .body{padding:12px 13px; display:flex; flex-direction:column; gap:6px; flex:1;}
    .post h3{margin:0; font-size:1.0rem; line-height:1.35;}
    .post .excerpt{margin:0; font-size:.92rem;}
    .post .meta{margin-top:auto;}

    /* Sidebar */
    .side{
      position:sticky;
      top:14px;
      display:flex;
      flex-direction:column;
      gap:14px;
    }
    @media(max-width:980px){.side{position:static;}}
    .box{padding:14px;}
    .box h4{margin:0 0 10px; font-size:1rem;}

    .pill{
      display:inline-flex;
      gap:8px;
      align-items:center;
      padding:8px 10px;
      border:1px solid var(--line);
      border-radius:999px;
      background:var(--soft);
      color:var(--muted);
      font-size:.85rem;
      margin:6px 6px 0 0;
      cursor:pointer;
      user-select:none;
      font-weight:700;
    }
    .pill.active{
      border-color: rgba(14,165,233,.35);
      background: rgba(14,165,233,.10);
      color: #0369a1;
    }

    .latestItem{
      display:flex; gap:10px; align-items:center;
      padding:10px;
      border-radius:14px;
      border:1px solid var(--line);
      background: var(--soft);
      cursor:pointer;
    }
    .latestItem img{
      width:56px; height:42px; object-fit:cover;
      border-radius:10px; border:1px solid var(--line);
      background:#fff;
    }
    .latestItem b{display:block; font-size:.92rem; line-height:1.25;}
    .latestItem span{color:var(--muted); font-size:.82rem;}

    /* Pager */
    .pager{
      display:flex;
      gap:10px;
      justify-content:center;
      flex-wrap:wrap;
      margin:14px 0 0;
    }
    .pageInfo{
      padding:10px 12px;
      border:1px solid var(--line);
      border-radius:999px;
      background:var(--soft);
      color:var(--muted);
      font-weight:800;
    }

    .empty{
      margin-top:10px;
      padding:14px;
      border:1px dashed var(--line);
      border-radius:14px;
      background: var(--soft);
      color: var(--muted);
    }

    /* Modal */
    .modal{
      position:fixed; inset:0;
      background: rgba(2,6,23,.45);
      display:none;
      align-items:center;
      justify-content:center;
      padding:16px;
      z-index:9999;
    }
    .modal.open{display:flex;}
    .modalCard{
      width:min(980px, 100%);
      max-height:90vh;
      overflow:auto;
      background: var(--card);
      border:1px solid var(--line);
      border-radius: 20px;
      box-shadow: 0 26px 80px rgba(2,6,23,.25);
    }
    .modalTop{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      padding:12px 14px;
      border-bottom:1px solid var(--line);
      position:sticky;
      top:0;
      background: var(--card);
    }
    .modalTop b{font-size:.95rem;}
    .modalBody{padding:14px;}
    .modalBody img{max-width:100%; border-radius:14px; border:1px solid var(--line); background:#fff;}
    .contentText{line-height:1.65; white-space:pre-wrap;}
    .shareRow{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;}

    /* Community Magazine dropdown card */
    .magRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    .magRow .toolbar{
      box-shadow:none;
      padding:0;
      border:none;
      background:transparent;
    }
    .magRow select{
      min-width: 240px;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <h1>Janasabha News</h1>
        <p>Latest updates from our district and neighbourhood Janasabhas.</p>
      </div>

      <!-- Login button RIGHT TOP -->
      <div class="loginTop">
        <a class="btn primary" href="login.html">Volunteer/Admin Login</a>
      </div>
    </header>

    <!-- Community dropdown LEFT + Refresh -->
    <div class="toolbarRow">
      <div class="toolbarLeft">
        <div class="toolbar">
          <label for="communityFilter">Community/ies:</label>
          <select id="communityFilter">
            <option value="ALL">All</option>
            <option value="Mannanam (Kottayam)">Mannanam (Kottayam)</option>
            <!-- Add more communities here -->
          </select>
        </div>
        <button class="btn" id="btnRefresh">Refresh</button>
      </div>
    </div>

    <div class="layout">
      <main>
        <div id="featuredWrap"></div>
        <div id="postsGrid" class="grid"></div>

        <div class="pager">
          <button class="btn" id="btnPrev" disabled>← Prev</button>
          <span class="pageInfo" id="pageInfo">Page 1 / 1</span>
          <button class="btn" id="btnNext" disabled>Next →</button>
        </div>

        <div id="emptyState" class="empty" style="display:none;">No news found.</div>
      </main>

      <aside class="side">
        <div class="card box">
          <h4>Categories</h4>
          <div id="catWrap"></div>
          <div style="color:var(--muted); margin-top:10px; font-size:.86rem;">Click a category to filter.</div>
        </div>

        <div class="card box">
          <h4>Latest Posts</h4>
          <div id="latestWrap"></div>
        </div>

        <!-- 3rd card = Community Magazine with dropdown -->
        <div class="card box">
          <h4>Community Magazine</h4>
          <div class="magRow">
            <div class="toolbar" style="width:100%;">
              <label for="magCommunity" style="min-width:110px;">Community:</label>
              <select id="magCommunity">
                <option value="ALL">All</option>
                <option value="Mannanam (Kottayam)">Mannanam (Kottayam)</option>
                <!-- Add more communities here -->
              </select>
            </div>
            <button class="btn primary" id="openMagazine">Open</button>
          </div>
          <div class="empty" style="margin-top:12px;">
            Tip: Select a community and click <b>Open</b> to go to that community magazine page/link.
          </div>
        </div>
      </aside>
    </div>
  </div>

  <!-- Modal -->
  <div class="modal" id="modal">
    <div class="modalCard">
      <div class="modalTop">
        <b id="modalTitle">News</b>
        <button class="btn" id="btnClose">Close</button>
      </div>
      <div class="modalBody">
        <div class="meta" id="modalMeta"></div>
        <div id="modalMedia" style="margin-top:10px;"></div>
        <h2 id="modalH2" style="margin:10px 0 6px;"></h2>
        <div class="contentText" id="modalContent"></div>

        <div class="shareRow" id="shareRow"></div>

        <div id="commentsBlock" style="margin-top:16px; padding-top:14px; border-top:1px solid var(--line);">
          <h3 style="margin:0 0 6px; font-size:1.05rem;">Comments</h3>
          <div id="commentsList" class="empty">Loading comments…</div>

          <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:10px;" id="commentForm">
            <div>
              <label style="display:block; color:var(--muted); margin:0 0 6px;">Your Name</label>
              <input id="cName" style="width:100%; padding:11px 12px; border-radius:12px; border:1px solid var(--line); background:var(--soft);" placeholder="Name" />
              <div style="color:var(--muted); font-size:.82rem; margin-top:6px;">
                Note: commenting requires login.
              </div>
            </div>
            <div>
              <label style="display:block; color:var(--muted); margin:0 0 6px;">Comment</label>
              <textarea id="cText" style="width:100%; padding:11px 12px; border-radius:12px; border:1px solid var(--line); background:var(--soft); min-height:70px;" placeholder="Write your comment…"></textarea>
            </div>
          </div>

          <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:10px; flex-wrap:wrap;">
            <button class="btn" id="btnReloadComments">Reload Comments</button>
            <button class="btn primary" id="btnAddComment">Post Comment</button>
          </div>

          <div id="commentStatus" class="empty" style="display:none; margin-top:10px;"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <script>
    // ✅ Paste your Firebase config
    const firebaseConfig = {
      apiKey: "PASTE",
      authDomain: "PASTE",
      projectId: "PASTE",
      storageBucket: "PASTE",
      messagingSenderId: "PASTE",
      appId: "PASTE"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // DOM
    const featuredWrap = document.getElementById("featuredWrap");
    const postsGrid = document.getElementById("postsGrid");
    const emptyState = document.getElementById("emptyState");
    const catWrap = document.getElementById("catWrap");
    const latestWrap = document.getElementById("latestWrap");

    const communityFilter = document.getElementById("communityFilter");
    const btnRefresh = document.getElementById("btnRefresh");

    const btnPrev = document.getElementById("btnPrev");
    const btnNext = document.getElementById("btnNext");
    const pageInfo = document.getElementById("pageInfo");

    // Magazine
    const magCommunity = document.getElementById("magCommunity");
    const openMagazine = document.getElementById("openMagazine");

    // Modal
    const modal = document.getElementById("modal");
    const btnClose = document.getElementById("btnClose");
    const modalTitle = document.getElementById("modalTitle");
    const modalMeta = document.getElementById("modalMeta");
    const modalMedia = document.getElementById("modalMedia");
    const modalH2 = document.getElementById("modalH2");
    const modalContent = document.getElementById("modalContent");
    const shareRow = document.getElementById("shareRow");

    const commentsList = document.getElementById("commentsList");
    const cName = document.getElementById("cName");
    const cText = document.getElementById("cText");
    const btnAddComment = document.getElementById("btnAddComment");
    const btnReloadComments = document.getElementById("btnReloadComments");
    const commentStatus = document.getElementById("commentStatus");

    btnClose.onclick = () => modal.classList.remove("open");
    modal.addEventListener("click", (e) => { if (e.target === modal) modal.classList.remove("open"); });

    // State
    let allNews = [];
    let activeCategory = "All";
    let activeCommunity = "ALL";

    // Pagination
    const PAGE_SIZE = 10; // cards per page (featured separate)
    let currentPage = 1;

    function safeText(v){ return (v || "").toString(); }

    function formatDate(ts){
      try{
        const d = ts?.toDate ? ts.toDate() : (ts ? new Date(ts) : null);
        if(!d || isNaN(d.getTime())) return "";
        return d.toLocaleDateString(undefined, { year:"numeric", month:"short", day:"numeric" });
      }catch(e){ return ""; }
    }

    // Google Drive direct image (Facebook photo links won't embed reliably)
    function normalizeImageUrl(url){
      const u = safeText(url).trim();
      if(!u) return "";
      if(!/^https?:\/\//i.test(u)) return "";

      const driveMatch = u.match(/drive\.google\.com\/file\/d\/([^\/]+)\//i);
      if (driveMatch && driveMatch[1]) return `https://drive.google.com/uc?export=view&id=${driveMatch[1]}`;

      const openId = u.match(/drive\.google\.com\/open\?id=([^&]+)/i);
      if (openId && openId[1]) return `https://drive.google.com/uc?export=view&id=${openId[1]}`;

      return u;
    }

    function buildCategories(items){
      const set = new Set(items.map(x => safeText(x.category).trim()).filter(Boolean));
      const cats = ["All", ...Array.from(set).sort((a,b)=>a.localeCompare(b))];

      catWrap.innerHTML = "";
      cats.forEach(cat => {
        const el = document.createElement("span");
        el.className = "pill" + (cat === activeCategory ? " active" : "");
        el.textContent = cat;
        el.onclick = () => {
          activeCategory = cat;
          currentPage = 1;
          buildCategories(allNews);
          render();
        };
        catWrap.appendChild(el);
      });
    }

    function getFiltered(){
      return allNews.filter(n => {
        const catOK = (activeCategory === "All") || (safeText(n.category).trim() === activeCategory);
        if(!catOK) return false;

        const comm = safeText(n.community).trim();
        const commOK = (activeCommunity === "ALL") || (comm === activeCommunity);
        if(!commOK) return false;

        return true;
      });
    }

    function updatePager(totalFiltered){
      const totalCards = Math.max(0, totalFiltered - 1); // featured separate
      const totalPages = Math.max(1, Math.ceil(totalCards / PAGE_SIZE));
      currentPage = Math.min(currentPage, totalPages);

      pageInfo.textContent = `Page ${currentPage} / ${totalPages}`;
      btnPrev.disabled = currentPage <= 1;
      btnNext.disabled = currentPage >= totalPages;

      btnPrev.onclick = () => { currentPage = Math.max(1, currentPage - 1); render(); };
      btnNext.onclick = () => { currentPage = Math.min(totalPages, currentPage + 1); render(); };
    }

    function renderFeatured(item){
      const img = normalizeImageUrl(item.mediaUrl);
      const reporter = safeText(item.reporterName);
      const dt = formatDate(item.createdAt || item.date);
      const meta = [reporter ? `Reporter: ${reporter}` : "", dt].filter(Boolean).join(" • ");

      featuredWrap.innerHTML = `
        <article class="card featured">
          <div class="media">
            ${img ? `<img src="${img}" alt="">` : `No image`}
          </div>
          <div class="content">
            <h2>${safeText(item.title) || "Untitled"}</h2>
            <div class="meta">
              <span class="badge">${safeText(item.category) || "General"}</span>
              <span class="badge">${safeText(item.community) || "All"}</span>
              <span>${meta}</span>
            </div>
            <p class="excerpt">${safeText(item.summary) || safeText(item.content).slice(0,160) || ""}</p>
            <div style="margin-top:10px;">
              <button class="btn primary" id="readFeatured">Read more</button>
            </div>
          </div>
        </article>
      `;
      document.getElementById("readFeatured").onclick = () => openPost(item);
    }

    function renderCards(items){
      postsGrid.innerHTML = "";
      items.forEach(item => {
        const img = normalizeImageUrl(item.mediaUrl);
        const reporter = safeText(item.reporterName);
        const dt = formatDate(item.createdAt || item.date);
        const meta = [item.category ? item.category : "General", item.community ? item.community : "All", reporter ? `Reporter: ${reporter}` : "", dt].filter(Boolean).join(" • ");

        const el = document.createElement("article");
        el.className = "card post";
        el.innerHTML = `
          <div class="thumb">
            ${img ? `<img src="${img}" alt="">` : `No image`}
          </div>
          <div class="body">
            <h3>${safeText(item.title) || "Untitled"}</h3>
            <p class="excerpt">${safeText(item.summary) || safeText(item.content).slice(0,110) || ""}</p>
            <div class="meta">${meta}</div>
          </div>
        `;
        el.onclick = () => openPost(item);
        postsGrid.appendChild(el);
      });
    }

    function renderLatest(items){
      latestWrap.innerHTML = "";
      const latest = items.slice(0, 6);
      if(!latest.length){
        latestWrap.innerHTML = `<div class="empty">No posts yet.</div>`;
        return;
      }

      latest.forEach(item => {
        const img = normalizeImageUrl(item.mediaUrl);
        const el = document.createElement("div");
        el.className = "latestItem";
        el.innerHTML = `
          ${img ? `<img src="${img}" alt="">` : `<div style="width:56px;height:42px;border-radius:10px;border:1px solid var(--line);background:#fff;"></div>`}
          <div>
            <b>${safeText(item.title) || "Untitled"}</b>
            <span>${formatDate(item.createdAt || item.date)}</span>
          </div>
        `;
        el.onclick = () => openPost(item);
        latestWrap.appendChild(el);
      });
    }

    // Share buttons
    function buildShareButtons(item){
      const url = location.origin + location.pathname + `?id=${encodeURIComponent(item.id)}`;
      const text = `${safeText(item.title)} - Janasabha News`;

      shareRow.innerHTML = `
        <button class="btn" id="shareCopy">Copy Link</button>
        <a class="btn primary" id="shareWA" target="_blank" rel="noopener">WhatsApp</a>
        <a class="btn" id="shareFB" target="_blank" rel="noopener">Facebook</a>
      `;

      document.getElementById("shareCopy").onclick = async () => {
        try{
          await navigator.clipboard.writeText(url);
          alert("Link copied!");
        }catch(e){
          prompt("Copy this link:", url);
        }
      };

      document.getElementById("shareWA").href =
        `https://wa.me/?text=${encodeURIComponent(text + " " + url)}`;

      document.getElementById("shareFB").href =
        `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(url)}`;
    }

    // Comments
    let currentOpenPost = null;

    async function loadComments(postId){
      commentsList.textContent = "Loading comments…";
      commentStatus.style.display = "none";

      const snap = await db.collection("news").doc(postId)
        .collection("comments")
        .orderBy("createdAt", "desc")
        .limit(50)
        .get();

      const items = snap.docs.map(d => ({ id:d.id, ...d.data() }));

      if(!items.length){
        commentsList.innerHTML = `<div class="empty">No comments yet.</div>`;
        return;
      }

      commentsList.innerHTML = items.map(c => {
        const dt = formatDate(c.createdAt);
        return `
          <div class="empty" style="border-style:solid;">
            <div style="color:var(--muted); font-weight:800; margin-bottom:6px;">
              ${safeText(c.name) || "Anonymous"} • ${dt}
            </div>
            <div style="white-space:pre-wrap; line-height:1.55;">${safeText(c.text)}</div>
          </div>
        `;
      }).join("");
    }

    async function addComment(){
      if(!currentOpenPost) return;

      const user = auth.currentUser;
      if(!user){
        commentStatus.style.display = "block";
        commentStatus.textContent = "Please login to post a comment.";
        return;
      }

      const name = cName.value.trim();
      const text = cText.value.trim();
      if(!name || !text){
        commentStatus.style.display = "block";
        commentStatus.textContent = "Please enter your name and comment.";
        return;
      }

      commentStatus.style.display = "none";

      await db.collection("news").doc(currentOpenPost.id)
        .collection("comments")
        .add({
          name,
          text,
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          uid: user.uid
        });

      cText.value = "";
      await loadComments(currentOpenPost.id);
    }

    btnAddComment.onclick = () => addComment();
    btnReloadComments.onclick = () => currentOpenPost ? loadComments(currentOpenPost.id) : null;

    function openPost(item){
      currentOpenPost = item;
      modal.classList.add("open");

      modalTitle.textContent = item.category ? `News • ${item.category}` : "News";

      const metaBits = [];
      if(item.community) metaBits.push(item.community);
      if(item.reporterName) metaBits.push(`Reporter: ${item.reporterName}`);
      const dt = formatDate(item.createdAt || item.date);
      if(dt) metaBits.push(dt);
      modalMeta.textContent = metaBits.join(" • ");

      const img = normalizeImageUrl(item.mediaUrl);
      modalMedia.innerHTML = img ? `<img src="${img}" alt="">` : "";

      modalH2.textContent = item.title || "Untitled";
      modalContent.textContent = item.content || item.summary || "";

      buildShareButtons(item);
      loadComments(item.id).catch(console.error);
    }

    function render(){
      const filtered = getFiltered();

      emptyState.style.display = filtered.length ? "none" : "block";

      if(!filtered.length){
        featuredWrap.innerHTML = "";
        postsGrid.innerHTML = "";
        renderLatest([]);
        updatePager(0);
        return;
      }

      // featured = first
      renderFeatured(filtered[0]);

      // paged cards
      const rest = filtered.slice(1);
      updatePager(filtered.length);

      const start = (currentPage - 1) * PAGE_SIZE;
      const pageItems = rest.slice(start, start + PAGE_SIZE);
      renderCards(pageItems);

      // sidebar latest
      renderLatest(filtered);
    }

    async function loadNews(){
      emptyState.style.display = "none";
      emptyState.textContent = "No news found.";

      try{
        // Prefer createdAt; fallback to date if old schema
        let snap;
        try{
          snap = await db.collection("news").orderBy("createdAt","desc").limit(100).get();
        }catch(e){
          snap = await db.collection("news").orderBy("date","desc").limit(100).get();
        }

        allNews = snap.docs.map(d => ({ id:d.id, ...d.data() }));

        buildCategories(allNews);
        currentPage = 1;
        render();

        // open by id if present
        const params = new URLSearchParams(location.search);
        const id = params.get("id");
        if(id){
          const found = allNews.find(x => x.id === id);
          if(found) openPost(found);
        }
      }catch(err){
        console.error(err);
        emptyState.style.display = "block";
        emptyState.textContent = "Failed to load news. Check Firestore rules & timestamps.";
      }
    }

    // Events
    communityFilter.addEventListener("change", () => {
      activeCommunity = communityFilter.value;
      currentPage = 1;
      render();
    });

    btnRefresh.addEventListener("click", () => loadNews());

    // Magazine "Open" mapping (edit links here)
    const MAGAZINE_LINKS = {
      "ALL": "magazine.html", // default magazine page
      "Mannanam (Kottayam)": "magazine-mannanam.html"
    };

    openMagazine.addEventListener("click", () => {
      const c = magCommunity.value || "ALL";
      const link = MAGAZINE_LINKS[c] || MAGAZINE_LINKS["ALL"];
      window.location.href = link;
    });

    // Initial values
    activeCommunity = communityFilter.value || "ALL";
    loadNews();
  </script>
</body>
</html>
