<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Janasabha News</title>
  <style>
    :root{
      --bg:#0b1020; --card:#121a33; --text:#e9eeff; --muted:#a7b4d6;
      --line:rgba(255,255,255,.10); --accent:#4fd1c5; --shadow: 0 14px 40px rgba(0,0,0,.22);
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background: radial-gradient(1200px 700px at 15% 10%, rgba(79,209,197,.18), transparent 55%),
                  radial-gradient(900px 600px at 90% 20%, rgba(120,110,255,.16), transparent 60%),
                  linear-gradient(180deg,#070a15, #0b1020 40%, #070a15);
      color:var(--text);
    }
    a{color:inherit; text-decoration:none}
    .wrap{max-width:1180px; margin:0 auto; padding:18px;}
    header{display:flex; align-items:flex-end; justify-content:space-between; gap:12px; flex-wrap:wrap; margin-bottom:14px;}
    .brand h1{margin:0; font-size:1.35rem;}
    .brand p{margin:.35rem 0 0; color:var(--muted); line-height:1.35}
    .top-actions{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .input{
      border:1px solid var(--line); background:rgba(255,255,255,.06); color:var(--text);
      padding:10px 12px; border-radius:999px; outline:none; min-width: 240px;
    }
    .btn{
      border:1px solid var(--line); background:rgba(255,255,255,.05); color:var(--text);
      padding:10px 12px; border-radius:999px; cursor:pointer; font-weight:700;
    }
    .btn:hover{border-color:rgba(255,255,255,.18)}
    .btn.accent{background:rgba(79,209,197,.12); border-color:rgba(79,209,197,.35)}
    .layout{display:grid; grid-template-columns: 1.9fr .9fr; gap:16px; align-items:start;}
    @media (max-width: 980px){.layout{grid-template-columns:1fr;}}

    .featured, .box, .post{
      background:rgba(18,26,51,.72);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
    }
    .featured{overflow:hidden; margin-bottom:16px;}
    .featured .media{position:relative; aspect-ratio: 16/7; background:rgba(255,255,255,.06);}
    .featured img{width:100%; height:100%; object-fit:cover; display:block;}
    .tag{
      position:absolute; left:14px; top:14px;
      background:rgba(0,0,0,.45);
      border:1px solid rgba(255,255,255,.18);
      padding:7px 10px;
      border-radius:999px;
      font-size:.82rem;
      backdrop-filter: blur(8px);
    }
    .featured .content{padding:14px;}
    .meta{display:flex; gap:10px; flex-wrap:wrap; color:var(--muted); font-size:.88rem; margin-top:6px;}
    .featured h2{margin:0; font-size:1.2rem; line-height:1.3;}
    .excerpt{color:var(--muted); margin:.55rem 0 0; line-height:1.45}

    .grid{display:grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap:14px;}
    @media (max-width: 720px){.grid{grid-template-columns:1fr;}}
    .post{overflow:hidden; display:flex; flex-direction:column; min-height: 100%;}
    .post .thumb{aspect-ratio: 16/9; background:rgba(255,255,255,.06); overflow:hidden;}
    .post .thumb img{width:100%; height:100%; object-fit:cover; display:block;}
    .post .body{padding:12px 13px; display:flex; flex-direction:column; gap:6px; flex:1;}
    .post h3{margin:0; font-size:1.02rem; line-height:1.35}
    .post .excerpt{margin:0; font-size:.92rem}
    .post .meta{margin-top:auto;}

    .side{position:sticky; top:14px; display:flex; flex-direction:column; gap:14px;}
    @media (max-width: 980px){.side{position:static;}}
    .box{padding:14px;}
    .box h4{margin:0 0 10px; font-size:1rem;}

    .pill{
      display:inline-flex; gap:8px; align-items:center; padding:8px 10px;
      border:1px solid var(--line); border-radius:999px; background:rgba(255,255,255,.03);
      color:var(--muted); font-size:.85rem; margin:6px 6px 0 0; cursor:pointer; user-select:none;
    }
    .pill.active{border-color:rgba(79,209,197,.5); background:rgba(79,209,197,.10); color:rgba(230,255,252,.92);}

    .latestItem{
      display:flex; gap:10px; align-items:center;
      padding:10px; border-radius:14px;
      border:1px solid rgba(255,255,255,.06);
      background:rgba(255,255,255,.03);
      cursor:pointer;
    }
    .latestItem img{width:56px; height:42px; object-fit:cover; border-radius:10px; border:1px solid rgba(255,255,255,.08);}
    .latestItem b{display:block; font-size:.92rem; line-height:1.25;}
    .latestItem span{color:var(--muted); font-size:.82rem;}

    .pager{
      display:flex; gap:10px; justify-content:center; flex-wrap:wrap;
      margin:16px 0 4px;
    }

    /* Modal */
    .modal{position:fixed; inset:0; background:rgba(0,0,0,.58); display:none; align-items:center; justify-content:center; padding:16px; z-index:9999;}
    .modal.open{display:flex;}
    .modalCard{
      width:min(980px, 100%); max-height: 90vh; overflow:auto;
      background:rgba(18,26,51,.92);
      border:1px solid rgba(255,255,255,.14);
      border-radius: 22px;
      box-shadow: 0 22px 60px rgba(0,0,0,.45);
    }
    .modalTop{
      display:flex; justify-content:space-between; gap:10px; align-items:center;
      padding:12px 14px; border-bottom:1px solid var(--line);
      position:sticky; top:0; backdrop-filter: blur(10px);
      background:rgba(18,26,51,.92);
    }
    .modalTop b{font-size:.95rem}
    .modalBody{padding:14px;}
    .modalBody img{max-width:100%; border-radius:16px; border:1px solid var(--line);}

    .shareRow{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;}
    .shareRow .btn{font-weight:800;}

    .comments{
      margin-top:16px;
      padding-top:14px;
      border-top:1px solid rgba(255,255,255,.10);
    }
    .comment{
      border:1px solid rgba(255,255,255,.08);
      background:rgba(255,255,255,.03);
      border-radius:14px;
      padding:10px 12px;
      margin-top:10px;
    }
    .comment .meta{margin:0 0 6px;}
    .commentForm{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
      margin-top:10px;
    }
    @media(max-width:720px){.commentForm{grid-template-columns:1fr;}}
    .commentForm textarea{min-height:70px;}

    .empty{
      padding:16px; border:1px dashed var(--line); border-radius:16px; color:var(--muted);
      background:rgba(255,255,255,.02);
    }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <h1>Janasabha News</h1>
        <p>Latest updates from our district and neighbourhood Janasabhas.</p>
      </div>

<div class="toolbar">
  <label for="communityFilter" style="font-size:14px;color:#444;">Community/ies:</label>
  <select id="communityFilter">
    <option value="ALL">All</option>
    <option value="Mannanam (Kottayam)">Mannanam (Kottayam)</option>
  </select>
</div>


      
      <div class="top-actions">
        <input id="search" class="input" placeholder="Search news…" />
        <button id="btnRefresh" class="btn">Refresh</button>
        <a class="btn accent" href="login.html">Volunteer/Admin Login</a>
      </div>
    </header>

    <div class="layout">
      <main>
        <div id="featuredWrap"></div>
        <div id="postsGrid" class="grid"></div>

        <div class="pager">
          <button class="btn" id="btnPrev" disabled>← Prev</button>
          <span class="pill" id="pageInfo" style="cursor:default;">Page 1</span>
          <button class="btn" id="btnNext" disabled>Next →</button>
        </div>

        <div id="emptyState" class="empty" style="display:none;">No news found.</div>
      </main>

      <aside class="side">
        <div class="box">
          <h4>Categories</h4>
          <div id="catWrap"></div>
          <div style="color:var(--muted); margin-top:10px; font-size:.86rem;">Click a category to filter.</div>
        </div>

        <div class="box">
          <h4>Latest Posts</h4>
          <div id="latestWrap"></div>
        </div>

        <div class="box">
          <h4>About</h4>
          <div style="color:var(--muted); line-height:1.5;">
            Powered by <b>Firebase</b> and hosted on <b>GitHub Pages</b>.
          </div>
        </div>
      </aside>
    </div>
  </div>

  <!-- Modal -->
  <div class="modal" id="modal">
    <div class="modalCard">
      <div class="modalTop">
        <b id="modalTitle">News</b>
        <button class="btn" id="btnClose">Close</button>
      </div>
      <div class="modalBody">
        <div class="meta" id="modalMeta"></div>

        <div id="modalMedia" style="margin-top:10px;"></div>

        <h2 id="modalH2" style="margin:10px 0 6px;"></h2>
        <div id="modalContent" style="color:rgba(233,238,255,.92); line-height:1.65; white-space:pre-wrap;"></div>

        <div class="shareRow" id="shareRow"></div>

        <div class="comments">
          <h3 style="margin:0 0 6px; font-size:1.05rem;">Comments</h3>
          <div id="commentsList"></div>

          <div class="commentForm">
            <div>
              <label style="display:block; color:var(--muted); margin:0 0 6px;">Your Name</label>
              <input id="cName" placeholder="Name" />
              <div style="color:var(--muted); font-size:.82rem; margin-top:6px;">
                Note: commenting requires login.
              </div>
            </div>
            <div>
              <label style="display:block; color:var(--muted); margin:0 0 6px;">Comment</label>
              <textarea id="cText" placeholder="Write your comment…"></textarea>
            </div>
          </div>

          <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:10px; flex-wrap:wrap;">
            <button class="btn" id="btnReloadComments">Reload Comments</button>
            <button class="btn accent" id="btnAddComment">Post Comment</button>
          </div>

          <div id="commentStatus" class="empty" style="display:none; margin-top:10px;"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <script>
    // ✅ Paste your config
    const firebaseConfig = {
      apiKey: "PASTE",
      authDomain: "PASTE",
      projectId: "PASTE",
      storageBucket: "PASTE",
      messagingSenderId: "PASTE",
      appId: "PASTE"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    const featuredWrap = document.getElementById("featuredWrap");
    const postsGrid = document.getElementById("postsGrid");
    const emptyState = document.getElementById("emptyState");
    const catWrap = document.getElementById("catWrap");
    const latestWrap = document.getElementById("latestWrap");
    const search = document.getElementById("search");

    const btnPrev = document.getElementById("btnPrev");
    const btnNext = document.getElementById("btnNext");
    const pageInfo = document.getElementById("pageInfo");

    const modal = document.getElementById("modal");
    const btnClose = document.getElementById("btnClose");
    const modalTitle = document.getElementById("modalTitle");
    const modalMeta = document.getElementById("modalMeta");
    const modalMedia = document.getElementById("modalMedia");
    const modalH2 = document.getElementById("modalH2");
    const modalContent = document.getElementById("modalContent");
    const shareRow = document.getElementById("shareRow");

    const commentsList = document.getElementById("commentsList");
    const cName = document.getElementById("cName");
    const cText = document.getElementById("cText");
    const btnAddComment = document.getElementById("btnAddComment");
    const btnReloadComments = document.getElementById("btnReloadComments");
    const commentStatus = document.getElementById("commentStatus");

    btnClose.onclick = () => modal.classList.remove("open");
    modal.addEventListener("click", (e) => { if(e.target === modal) modal.classList.remove("open"); });

    let allNews = [];
    let activeCategory = "All";

    // Pagination state
    const PAGE_SIZE = 10;       // cards per page (featured is separate)
    let currentPage = 1;

    function safeText(v){ return (v || "").toString(); }

    function formatDate(ts){
      try{
        const d = ts?.toDate ? ts.toDate() : (ts ? new Date(ts) : null);
        if(!d) return "";
        return d.toLocaleDateString(undefined, { year:"numeric", month:"short", day:"numeric" });
      }catch(e){ return ""; }
    }

    // ✅ Better image support for Google Drive / Google Photos shared links
    function normalizeImageUrl(url){
      const u = safeText(url).trim();
      if(!u) return "";

      // allow direct http(s)
      if(!/^https?:\/\//i.test(u)) return "";

      // Google Drive file link -> direct view
      // example: https://drive.google.com/file/d/FILE_ID/view?usp=sharing
      const driveMatch = u.match(/drive\.google\.com\/file\/d\/([^\/]+)\//i);
      if (driveMatch && driveMatch[1]) {
        return `https://drive.google.com/uc?export=view&id=${driveMatch[1]}`;
      }

      // Google Drive open?id=FILE_ID
      const openId = u.match(/drive\.google\.com\/open\?id=([^&]+)/i);
      if (openId && openId[1]) {
        return `https://drive.google.com/uc?export=view&id=${openId[1]}`;
      }

      // Google Photos shared links often don’t allow hotlinking reliably.
      // We'll keep as-is; may or may not render.
      // Facebook photo links generally won't render as image due to access/cookies.

      return u;
    }

    function buildCategories(items){
      const set = new Set(items.map(x => safeText(x.category).trim()).filter(Boolean));
      const cats = ["All", ...Array.from(set).sort((a,b)=>a.localeCompare(b))];

      catWrap.innerHTML = "";
      cats.forEach(cat => {
        const el = document.createElement("span");
        el.className = "pill" + (cat === activeCategory ? " active" : "");
        el.textContent = cat;
        el.onclick = () => {
          activeCategory = cat;
          currentPage = 1;
          buildCategories(allNews);
          render();
        };
        catWrap.appendChild(el);
      });
    }

    function getFiltered(){
      const q = search.value.trim().toLowerCase();
      return allNews.filter(n => {
        const catOK = (activeCategory === "All") || (safeText(n.category).trim() === activeCategory);
        if(!catOK) return false;
        if(!q) return true;
        const hay = (safeText(n.title)+" "+safeText(n.summary)+" "+safeText(n.content)+" "+safeText(n.reporterName)+" "+safeText(n.category)).toLowerCase();
        return hay.includes(q);
      });
    }

    function updatePager(totalItems){
      const totalPages = Math.max(1, Math.ceil(Math.max(0, totalItems - 1) / PAGE_SIZE)); // -1 because featured
      currentPage = Math.min(currentPage, totalPages);

      pageInfo.textContent = `Page ${currentPage} / ${totalPages}`;

      btnPrev.disabled = currentPage <= 1;
      btnNext.disabled = currentPage >= totalPages;

      btnPrev.onclick = () => { currentPage = Math.max(1, currentPage - 1); render(); };
      btnNext.onclick = () => { currentPage = currentPage + 1; render(); };
    }

    function renderFeatured(item){
      const img = normalizeImageUrl(item.mediaUrl);
      const cat = safeText(item.category) || "News";
      const reporter = safeText(item.reporterName);
      const dt = formatDate(item.createdAt);
      const meta = [reporter ? `Reporter: ${reporter}` : "", dt].filter(Boolean).join(" • ");

      featuredWrap.innerHTML = `
        <article class="featured">
          <div class="media">
            ${img ? `<img src="${img}" alt="">` : `<div style="height:100%; display:flex; align-items:center; justify-content:center; color:var(--muted);">No image</div>`}
            <span class="tag">${cat}</span>
          </div>
          <div class="content">
            <h2>${safeText(item.title) || "Untitled"}</h2>
            <div class="meta">${meta}</div>
            <p class="excerpt">${safeText(item.summary) || safeText(item.content).slice(0,140) || ""}</p>
            <div style="margin-top:10px;">
              <button class="btn accent" id="readFeatured">Read more</button>
            </div>
          </div>
        </article>
      `;
      document.getElementById("readFeatured").onclick = () => openPost(item);
    }

    function renderCards(items){
      postsGrid.innerHTML = "";
      items.forEach(item => {
        const img = normalizeImageUrl(item.mediaUrl);
        const cat = safeText(item.category) || "News";
        const reporter = safeText(item.reporterName);
        const dt = formatDate(item.createdAt);
        const meta = [cat, reporter ? `Reporter: ${reporter}` : "", dt].filter(Boolean).join(" • ");

        const el = document.createElement("article");
        el.className = "post";
        el.innerHTML = `
          <div class="thumb">
            ${img ? `<img src="${img}" alt="">` : `<div style="height:100%; display:flex; align-items:center; justify-content:center; color:var(--muted);">No image</div>`}
          </div>
          <div class="body">
            <h3>${safeText(item.title) || "Untitled"}</h3>
            <p class="excerpt">${safeText(item.summary) || safeText(item.content).slice(0,110) || ""}</p>
            <div class="meta">${meta}</div>
          </div>
        `;
        el.onclick = () => openPost(item);
        postsGrid.appendChild(el);
      });
    }

    function renderLatest(items){
      latestWrap.innerHTML = "";
      const latest = items.slice(0, 6);
      latest.forEach(item => {
        const img = normalizeImageUrl(item.mediaUrl);
        const el = document.createElement("div");
        el.className = "latestItem";
        el.innerHTML = `
          ${img ? `<img src="${img}" alt="">` : `<div style="width:56px; height:42px; border-radius:10px; border:1px solid rgba(255,255,255,.08); background:rgba(255,255,255,.06);"></div>`}
          <div>
            <b>${safeText(item.title) || "Untitled"}</b>
            <span>${formatDate(item.createdAt)}</span>
          </div>
        `;
        el.onclick = () => openPost(item);
        latestWrap.appendChild(el);
      });

      if(!latest.length){
        latestWrap.innerHTML = `<div style="color:var(--muted);">No posts yet.</div>`;
      }
    }

    // Share buttons
    function buildShareButtons(item){
      const url = location.origin + location.pathname + `?id=${encodeURIComponent(item.id)}`;
      const text = `${safeText(item.title)} - Janasabha News`;

      shareRow.innerHTML = `
        <button class="btn" id="shareCopy">Copy Link</button>
        <a class="btn accent" id="shareWA" target="_blank">WhatsApp</a>
        <a class="btn" id="shareFB" target="_blank">Facebook</a>
      `;

      document.getElementById("shareCopy").onclick = async () => {
        try{
          await navigator.clipboard.writeText(url);
          alert("Link copied!");
        }catch(e){
          prompt("Copy this link:", url);
        }
      };

      document.getElementById("shareWA").href =
        `https://wa.me/?text=${encodeURIComponent(text + " " + url)}`;

      document.getElementById("shareFB").href =
        `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(url)}`;
    }

    // Comments
    let currentOpenPost = null;

    async function loadComments(postId){
      commentsList.innerHTML = `<div style="color:var(--muted);">Loading comments…</div>`;
      commentStatus.style.display = "none";

      const snap = await db.collection("news").doc(postId)
        .collection("comments")
        .orderBy("createdAt", "desc")
        .limit(50)
        .get();

      const items = snap.docs.map(d => ({ id:d.id, ...d.data() }));

      if(!items.length){
        commentsList.innerHTML = `<div style="color:var(--muted);">No comments yet.</div>`;
        return;
      }

      commentsList.innerHTML = "";
      items.forEach(c => {
        const el = document.createElement("div");
        el.className = "comment";
        const dt = formatDate(c.createdAt);
        el.innerHTML = `
          <div class="meta">${safeText(c.name) || "Anonymous"} • ${dt}</div>
          <div style="white-space:pre-wrap; line-height:1.55;">${safeText(c.text)}</div>
        `;
        commentsList.appendChild(el);
      });
    }

    async function addComment(){
      if(!currentOpenPost) return;

      const user = auth.currentUser;
      if(!user){
        commentStatus.style.display = "block";
        commentStatus.textContent = "Please login to post a comment.";
        return;
      }

      const name = cName.value.trim();
      const text = cText.value.trim();
      if(!name || !text){
        commentStatus.style.display = "block";
        commentStatus.textContent = "Please enter your name and comment.";
        return;
      }

      commentStatus.style.display = "none";

      await db.collection("news").doc(currentOpenPost.id)
        .collection("comments")
        .add({
          name,
          text,
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          uid: user.uid
        });

      cText.value = "";
      await loadComments(currentOpenPost.id);
    }

    btnAddComment.onclick = () => addComment();
    btnReloadComments.onclick = () => currentOpenPost ? loadComments(currentOpenPost.id) : null;

    function openPost(item){
      currentOpenPost = item;
      modal.classList.add("open");
      modalTitle.textContent = item.category ? `News • ${item.category}` : "News";

      const metaBits = [];
      if(item.reporterName) metaBits.push(`Reporter: ${item.reporterName}`);
      const dt = formatDate(item.createdAt);
      if(dt) metaBits.push(dt);
      modalMeta.textContent = metaBits.join(" • ");

      const img = normalizeImageUrl(item.mediaUrl);
      modalMedia.innerHTML = img ? `<img src="${img}" alt="">` : "";

      modalH2.textContent = item.title || "Untitled";
      modalContent.textContent = item.content || item.summary || "";

      buildShareButtons(item);
      loadComments(item.id).catch(console.error);
    }

    function render(){
      const filtered = getFiltered();

      emptyState.style.display = filtered.length ? "none" : "block";

      if(!filtered.length){
        featuredWrap.innerHTML = "";
        postsGrid.innerHTML = "";
        renderLatest([]);
        updatePager(0);
        return;
      }

      // Featured always = first in filtered
      const featured = filtered[0];
      renderFeatured(featured);

      // Cards pagination for the rest
      const rest = filtered.slice(1);
      updatePager(filtered.length);

      const start = (currentPage - 1) * PAGE_SIZE;
      const pageItems = rest.slice(start, start + PAGE_SIZE);
      renderCards(pageItems);

      // Latest widget uses overall filtered (or overall allNews if you prefer)
      renderLatest(filtered);
    }

    async function loadNews(){
      const snap = await db.collection("news")
        .orderBy("createdAt", "desc")
        .limit(100)
        .get();

      allNews = snap.docs.map(d => ({ id:d.id, ...d.data() }));

      buildCategories(allNews);
      currentPage = 1;
      render();

      // If URL has ?id=docId open that post
      const params = new URLSearchParams(location.search);
      const id = params.get("id");
      if(id){
        const found = allNews.find(x => x.id === id);
        if(found) openPost(found);
      }
    }

    document.getElementById("btnRefresh").onclick = () => loadNews();
    search.addEventListener("input", () => { currentPage = 1; render(); });

    // Auth (for commenting)
    auth.onAuthStateChanged(() => { /* just to update comment ability */ });

    // Load
    loadNews().catch(err => {
      console.error(err);
      emptyState.style.display = "block";
      emptyState.textContent = "Failed to load news. Check Firestore rules & createdAt field.";
    });
  </script>
</body>
</html>
